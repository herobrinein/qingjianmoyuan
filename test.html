<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker 缓存测试</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #4a90e2, #6ab0ff);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeaea;
        }
        
        .section h2 {
            color: #4a90e2;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4a90e2;
        }
        
        .status-box.error {
            border-left-color: #e74c3c;
            background-color: #ffeaea;
        }
        
        .status-box.success {
            border-left-color: #2ecc71;
            background-color: #eaffea;
        }
        
        .status-box.warning {
            border-left-color: #f39c12;
            background-color: #fff8e6;
        }
        
        .status-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-content {
            font-family: 'Monaco', 'Consolas', monospace;
            background: white;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-top: 10px;
            border: 1px solid #eaeaea;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #357ABD;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #d68910;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .btn-secondary {
            background: #7f8c8d;
        }
        
        .btn-secondary:hover {
            background: #6c7b7d;
            box-shadow: 0 5px 15px rgba(127, 140, 141, 0.4);
        }
        
        .btn i {
            font-size: 1.1em;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #eee;
        }
        
        .cache-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #eaeaea;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .logs {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-time {
            color: #888;
            margin-right: 10px;
        }
        
        .log-info {
            color: #4a90e2;
        }
        
        .log-error {
            color: #ff5555;
        }
        
        .log-success {
            color: #55ff55;
        }
        
        .log-warning {
            color: #ffaa00;
        }
        
        .protocol-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .protocol-warning i {
            font-size: 1.5em;
        }
        
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .password-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .password-box h2 {
            color: #4a90e2;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .password-box p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .password-input:focus {
            border-color: #4a90e2;
            outline: none;
        }
        
        .password-error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        
        .password-error.show {
            display: block;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
                flex-direction: column;
                gap: 10px;
            }
            
            .back-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                width: 100%;
                justify-content: center;
            }
            
            .content {
                padding: 20px;
            }
            
            .cache-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 密码输入界面 -->
    <div id="password-overlay" class="password-overlay">
        <div class="password-box">
            <h2><i class="fas fa-lock"></i> 身份验证</h2>
            <p>请输入访问密码以使用缓存测试工具</p>
            <input type="password" id="password-input" class="password-input" placeholder="输入访问密码">
            <button id="password-submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-key"></i> 验证密码
            </button>
            <div id="password-error" class="password-error">
                <i class="fas fa-exclamation-circle"></i> 密码错误，请重试
            </div>
			
			<!-- 新增：返回按钮 -->
            <a href="/" class="btn btn-secondary" style="width: 100%; margin-top: 15px; text-decoration: none; justify-content: center;">
                <i class="fas fa-arrow-left"></i> 返回朗诵页面
            </a>
        </div>
    </div>
    
    <div class="container" id="main-container" style="display: none;">
        <div class="header">
            <a href="/" class="back-button">
                <i class="fas fa-arrow-left"></i> 返回朗诵页面
            </a>
            <h1><i class="fas fa-database"></i> Service Worker 缓存测试工具</h1>
            <p>此页面用于测试Service Worker缓存功能，检查缓存状态、配置和通信是否正常</p>
        </div>
        
        <div class="content">
            <div id="protocol-warning" class="protocol-warning hidden">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>警告：检测到本地文件协议 (file://)</strong><br>
                    Service Worker 在本地文件协议下无法正常工作。请通过HTTP服务器（如 localhost）访问此页面。
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-plug"></i> Service Worker 状态</h2>
                
                <div id="sw-status" class="status-box">
                    <div class="status-title"><i class="fas fa-circle-notch fa-spin"></i> 正在检测Service Worker...</div>
                    <div id="sw-status-content" class="status-content">请稍候...</div>
                </div>
                
                <div id="sw-controls" class="controls hidden">
                    <button id="register-btn" class="btn btn-success">
                        <i class="fas fa-plus-circle"></i> 注册Service Worker
                    </button>
                    <button id="unregister-btn" class="btn btn-danger">
                        <i class="fas fa-trash"></i> 注销所有Service Worker
                    </button>
                    <button id="update-btn" class="btn btn-warning">
                        <i class="fas fa-sync-alt"></i> 更新Service Worker
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-chart-bar"></i> 缓存状态</h2>
                
                <div id="cache-stats" class="cache-stats">
                    <!-- 缓存统计数据将通过JS动态填充 -->
                </div>
                
                <div id="cache-status" class="status-box">
                    <div class="status-title"><i class="fas fa-database"></i> 缓存详情</div>
                    <div id="cache-status-content" class="status-content">点击"获取缓存状态"按钮查看详情</div>
                </div>
                
                <div class="btn-group">
                    <button id="get-cache-btn" class="btn">
                        <i class="fas fa-download"></i> 获取缓存状态
                    </button>
                    <button id="clear-cache-btn" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> 清理MP3缓存
                    </button>
                    <button id="refresh-cache-btn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> 刷新缓存配置
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-cogs"></i> 缓存配置</h2>
                
                <div id="cache-config" class="status-box">
                    <div class="status-title"><i class="fas fa-sliders-h"></i> 当前配置</div>
                    <div id="cache-config-content" class="status-content">等待获取配置...</div>
                </div>
                
                <div class="btn-group">
                    <button id="get-config-btn" class="btn">
                        <i class="fas fa-cog"></i> 获取配置
                    </button>
                    <button id="update-config-btn" class="btn btn-success">
                        <i class="fas fa-save"></i> 更新配置
                    </button>
                </div>
                
                <div id="config-editor" class="status-box hidden">
                    <div class="status-title"><i class="fas fa-edit"></i> 编辑配置</div>
                    <div style="margin-top: 15px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                                <input type="checkbox" id="enable-mp3-cache" checked> 启用MP3缓存
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                                MP3缓存限制（首）: <span id="mp3-limit-value">30</span>
                            </label>
                            <input type="range" id="mp3-cache-limit" min="0" max="200" value="30" style="width: 100%;">
                        </div>
                        
                        <button id="save-config-btn" class="btn btn-success" style="width: 100%;">
                            <i class="fas fa-check"></i> 保存配置
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-terminal"></i> 测试日志</h2>
                
                <div class="btn-group">
                    <button id="clear-logs-btn" class="btn btn-secondary">
                        <i class="fas fa-broom"></i> 清除日志
                    </button>
                    <button id="test-cache-btn" class="btn">
                        <i class="fas fa-vial"></i> 测试缓存功能
                    </button>
                    <button id="test-fetch-btn" class="btn">
                        <i class="fas fa-network-wired"></i> 测试资源获取
                    </button>
                </div>
                
                <div id="logs-container" class="logs">
                    <div class="log-entry"><span class="log-time">[系统]</span> <span class="log-info">缓存测试工具已启动</span></div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>青简墨缘 - Service Worker 缓存测试工具 | 最后更新: 2025年</p>
            <p>使用说明: 此工具需要HTTPS或localhost环境才能正常工作</p>
        </div>
    </div>

    <script>
        // 全局变量
        let logs = [];
        let serviceWorkerRegistration = null;
        let isAuthenticated = false;
        
        // DOM元素
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const passwordError = document.getElementById('password-error');
        const mainContainer = document.getElementById('main-container');
        const protocolWarning = document.getElementById('protocol-warning');
        const swStatus = document.getElementById('sw-status');
        const swStatusContent = document.getElementById('sw-status-content');
        const swControls = document.getElementById('sw-controls');
        const cacheStats = document.getElementById('cache-stats');
        const cacheStatus = document.getElementById('cache-status');
        const cacheStatusContent = document.getElementById('cache-status-content');
        const cacheConfig = document.getElementById('cache-config');
        const cacheConfigContent = document.getElementById('cache-config-content');
        const configEditor = document.getElementById('config-editor');
        const logsContainer = document.getElementById('logs-container');
		
		// 在页面加载后立即绑定密码验证事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 密码验证事件监听器 - 必须在页面加载时立即绑定
            passwordSubmit.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
            
            // 自动聚焦到密码输入框
            passwordInput.focus();
        });
        
        // 密码验证
        function checkPassword() {
            const password = passwordInput.value.trim();
            const correctPassword = 'HerobrineIsHere'; // 预设密码
            
            if (password === correctPassword) {
                // 密码正确
                isAuthenticated = true;
                passwordOverlay.style.display = 'none';
                mainContainer.style.display = 'block';
                addLog('密码验证成功，进入缓存测试工具', 'success');
                
                // 初始化应用
                initApp();
            } else {
                // 密码错误
                passwordError.classList.add('show');
                passwordInput.value = '';
                passwordInput.focus();
                setTimeout(() => {
                    passwordError.classList.remove('show');
                }, 3000);
            }
        }
        
        // 初始化应用
        function initApp() {
            // 检查协议
            checkProtocol();
            
            // 初始化事件监听器
            initEventListeners();
            
            // 检测Service Worker状态
            detectServiceWorker();
        }
        
        // 检查协议
        function checkProtocol() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '[::1]';
            const isSecure = window.isSecureContext; // 浏览器原生检查安全上下文
            
            const warningBox = document.getElementById('protocol-warning');
            
            // 1. 检查 file:// 协议 (绝对不可用)
            if (protocol === 'file:') {
                warningBox.classList.remove('hidden');
                // 保持原有提示文本即可，或者在这里动态修改 innerHTML
                addLog('警告: 检测到本地文件协议 (file://)，Service Worker 无法工作', 'warning');
                return;
            } 
            
            // 2. 检查非安全上下文 (比如 http://192.168.x.x，SW 也是不工作的)
            if (!isSecure && !isLocalhost) {
                warningBox.classList.remove('hidden');
                // 修改提示文字，告诉用户 HTTP 也不行（除非是 localhost）
                warningBox.innerHTML = `
                    <i class="fas fa-unlock-alt"></i>
                    <div>
                        <strong>警告：检测到不安全的 HTTP 连接</strong><br>
                        Service Worker 需要 <strong>HTTPS</strong> 或 <strong>localhost</strong> 才能工作。<br>
                        当前地址 (${window.location.href}) 不受支持。
                    </div>
                `;
                addLog('警告: 当前不是安全上下文 (需要 HTTPS 或 localhost)', 'error');
                return;
            }

            // 3. 一切正常，确保隐藏警告框
            warningBox.classList.add('hidden');
            
            if (isLocalhost) {
                addLog(`当前环境: 本地开发环境 (${hostname})，Service Worker 正常工作`, 'success');
            } else {
                addLog(`当前环境: HTTPS 安全环境，Service Worker 正常工作`, 'success');
            }
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            
            // Service Worker控制按钮
            document.getElementById('register-btn').addEventListener('click', registerServiceWorker);
            document.getElementById('unregister-btn').addEventListener('click', unregisterServiceWorkers);
            document.getElementById('update-btn').addEventListener('click', updateServiceWorker);
            
            // 缓存控制按钮
            document.getElementById('get-cache-btn').addEventListener('click', getCacheStatus);
            document.getElementById('clear-cache-btn').addEventListener('click', clearMp3Cache);
            document.getElementById('refresh-cache-btn').addEventListener('click', refreshCacheConfig);
            
            // 配置控制按钮
            document.getElementById('get-config-btn').addEventListener('click', getCacheConfig);
            document.getElementById('update-config-btn').addEventListener('click', toggleConfigEditor);
            document.getElementById('save-config-btn').addEventListener('click', saveCacheConfig);
            
            // 滑条事件
            const mp3CacheLimit = document.getElementById('mp3-cache-limit');
            const mp3LimitValue = document.getElementById('mp3-limit-value');
            mp3CacheLimit.addEventListener('input', (e) => {
                mp3LimitValue.textContent = e.target.value;
            });
            
            // 测试按钮
            document.getElementById('clear-logs-btn').addEventListener('click', clearLogs);
            document.getElementById('test-cache-btn').addEventListener('click', testCacheFunctionality);
            document.getElementById('test-fetch-btn').addEventListener('click', testResourceFetch);
            
            // 监听Service Worker消息
            navigator.serviceWorker?.addEventListener('message', handleServiceWorkerMessage);
        }
        
        // 检测Service Worker状态
        function detectServiceWorker() {
            addLog('正在检测Service Worker支持情况...', 'info');
            
            if (!('serviceWorker' in navigator)) {
                updateSwStatus('error', '浏览器不支持 Service Worker API');
                addLog('错误: 浏览器不支持 Service Worker API', 'error');
                return;
            }
            
            addLog('Service Worker API 可用', 'success');
            
            // 检查是否已有注册的Service Worker
            navigator.serviceWorker.getRegistration().then(reg => {
                if (reg) {
                    serviceWorkerRegistration = reg;
                    updateSwStatus('success', `Service Worker 已注册 (作用域: ${reg.scope})`);
                    addLog(`Service Worker 已注册，作用域: ${reg.scope}`, 'success');
                    swControls.classList.remove('hidden');
                    
                    // 检查是否已激活
                    if (reg.active) {
                        addLog('Service Worker 已激活并控制页面', 'success');
                    } else if (reg.installing) {
                        addLog('Service Worker 正在安装...', 'info');
                    } else if (reg.waiting) {
                        addLog('Service Worker 在等待状态', 'warning');
                    }
                } else {
                    updateSwStatus('warning', '未找到注册的 Service Worker');
                    addLog('未找到注册的 Service Worker', 'warning');
                    swControls.classList.remove('hidden');
                }
            }).catch(err => {
                updateSwStatus('error', `获取 Service Worker 注册失败: ${err.message}`);
                addLog(`获取 Service Worker 注册失败: ${err.message}`, 'error');
            });
        }
        
        // 注册Service Worker
        function registerServiceWorker() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('正在注册 Service Worker...', 'info');
            
            navigator.serviceWorker.register('./service-worker.js', { 
                scope: './',
                updateViaCache: 'none'
            })
            .then(reg => {
                serviceWorkerRegistration = reg;
                    serviceWorkerRegistration = reg;
                    addLog(`Service Worker 注册成功! 作用域: ${reg.scope}`, 'success');
                    
                    // 监听安装和激活事件
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        addLog('检测到新的 Service Worker 版本', 'info');
                        
                        newWorker.addEventListener('statechange', () => {
                            addLog(`Service Worker 状态: ${newWorker.state}`, 'info');
                        });
                    });
                    
                    // 更新状态显示
                    updateSwStatus('success', `Service Worker 注册成功 (作用域: ${reg.scope})`);
                    
                    // 等待激活
                    if (reg.active) {
                        addLog('Service Worker 已激活', 'success');
                    } else {
                        addLog('等待 Service Worker 激活...', 'info');
                        reg.installing?.addEventListener('statechange', function() {
                            if (this.state === 'activated') {
                                addLog('Service Worker 已激活并控制页面', 'success');
                            }
                        });
                    }
                })
                .catch(err => {
                    addLog(`Service Worker 注册失败: ${err.message}`, 'error');
                    updateSwStatus('error', `注册失败: ${err.message}`);
                });
        }
        
        // 注销所有Service Worker
        function unregisterServiceWorkers() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('正在注销所有 Service Worker...', 'warning');
            
            navigator.serviceWorker.getRegistrations().then(registrations => {
                if (registrations.length === 0) {
                    addLog('没有找到需要注销的 Service Worker', 'info');
                    return;
                }
                
                const promises = registrations.map(reg => {
                    addLog(`正在注销: ${reg.scope}`, 'info');
                    return reg.unregister();
                });
                
                Promise.all(promises).then(results => {
                    const successCount = results.filter(result => result).length;
                    addLog(`已成功注销 ${successCount}/${registrations.length} 个 Service Worker`, 'success');
                    serviceWorkerRegistration = null;
                    updateSwStatus('warning', '所有 Service Worker 已注销');
                });
            }).catch(err => {
                addLog(`注销 Service Worker 失败: ${err.message}`, 'error');
            });
        }
        
        // 更新Service Worker
        function updateServiceWorker() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('正在检查 Service Worker 更新...', 'info');
            
            if (!serviceWorkerRegistration) {
                addLog('没有注册的 Service Worker，无法更新', 'error');
                return;
            }
            
            serviceWorkerRegistration.update()
                .then(() => {
                    addLog('Service Worker 更新检查完成', 'success');
                })
                .catch(err => {
                    addLog(`更新 Service Worker 失败: ${err.message}`, 'error');
                });
        }
        
        // 获取缓存状态
        function getCacheStatus() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('正在获取缓存状态...', 'info');
            
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                addLog('Service Worker 未就绪，无法获取缓存状态', 'error');
                updateCacheStatus('error', 'Service Worker 未就绪');
                return;
            }
            
            navigator.serviceWorker.controller.postMessage('get-cache-status');
            addLog('已发送缓存状态请求', 'info');
        }
        
        // 清理MP3缓存
        function clearMp3Cache() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            if (!confirm('确定要清理所有 MP3 缓存吗？这不会删除应用核心文件。')) {
                return;
            }
            
            addLog('正在清理 MP3 缓存...', 'warning');
            
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                addLog('Service Worker 未就绪，无法清理缓存', 'error');
                return;
            }
            
            navigator.serviceWorker.controller.postMessage('clear-mp3-cache');
            addLog('已发送清理 MP3 缓存请求', 'info');
            
            // 延迟刷新状态
            setTimeout(() => {
                getCacheStatus();
            }, 1000);
        }
        
        // 刷新缓存配置
        function refreshCacheConfig() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('正在刷新缓存配置...', 'info');
            
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                addLog('Service Worker 未就绪，无法刷新配置', 'error');
                return;
            }
            
            // 发送配置请求
            navigator.serviceWorker.controller.postMessage({ type: 'get-cache-config' });
            addLog('已发送获取缓存配置请求', 'info');
            
            // 同时获取缓存状态
            getCacheStatus();
        }
        
        // 获取缓存配置
        function getCacheConfig() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('正在获取缓存配置...', 'info');
            
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                addLog('Service Worker 未就绪，无法获取配置', 'error');
                updateCacheConfig('error', 'Service Worker 未就绪');
                return;
            }
            
            navigator.serviceWorker.controller.postMessage({ type: 'get-cache-config' });
            addLog('已发送获取配置请求', 'info');
        }
        
        // 切换配置编辑器显示
        function toggleConfigEditor() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            const isHidden = configEditor.classList.contains('hidden');
            configEditor.classList.toggle('hidden');
            
            if (!isHidden) {
                // 如果正在显示编辑器，先获取当前配置
                getCacheConfig();
            }
        }
        
        // 保存缓存配置
        function saveCacheConfig() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            const enableMp3Cache = document.getElementById('enable-mp3-cache').checked;
            const mp3CacheLimit = parseInt(document.getElementById('mp3-cache-limit').value);
            
            const newConfig = {
                enableMp3Cache: enableMp3Cache,
                maxMp3CacheCount: mp3CacheLimit
            };
            
            addLog(`正在保存配置: MP3缓存=${enableMp3Cache}, 限制=${mp3CacheLimit}首`, 'info');
            
            if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
                addLog('Service Worker 未就绪，无法保存配置', 'error');
                return;
            }
            
            navigator.serviceWorker.controller.postMessage({
                type: 'update-cache-config',
                config: newConfig
            });
            
            addLog('配置已发送到 Service Worker', 'success');
        }
        
        // 测试缓存功能
        function testCacheFunctionality() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('开始测试缓存功能...', 'info');
            
            // 测试1: 检查缓存API
            addLog('测试1: 检查缓存API支持', 'info');
            
            if (!('caches' in window)) {
                addLog('错误: 浏览器不支持 Cache API', 'error');
                return;
            }
            
            addLog('Cache API 可用', 'success');
            
            // 测试2: 列出所有缓存
            caches.keys().then(cacheNames => {
                addLog(`测试2: 找到 ${cacheNames.length} 个缓存: ${cacheNames.join(', ')}`, 'success');
                
                // 测试3: 检查每个缓存的内容
                const promises = cacheNames.map(cacheName => {
                    return caches.open(cacheName).then(cache => {
                        return cache.keys().then(requests => {
                            addLog(`缓存 "${cacheName}" 中有 ${requests.length} 个条目`, 'info');
                            return { name: cacheName, count: requests.length };
                        });
                    });
                });
                
                return Promise.all(promises);
            }).then(results => {
                // 显示结果
                const totalEntries = results.reduce((sum, cache) => sum + cache.count, 0);
                addLog(`总计: ${results.length} 个缓存，${totalEntries} 个缓存条目`, 'success');
            }).catch(err => {
                addLog(`缓存测试失败: ${err.message}`, 'error');
            });
        }
        
        // 测试资源获取
        function testResourceFetch() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            addLog('开始测试资源获取...', 'info');
            
            // 测试获取一些关键资源
            const testUrls = [
                './data.json',
                './service-worker.js',
                './index.html',
                './music/A Familiar Room.mp3',
                './icons/icon-192.png'
            ];
            
            let completed = 0;
            let successCount = 0;
            
            testUrls.forEach(url => {
                fetch(url)
                    .then(response => {
                        completed++;
                        if (response.ok) {
                            successCount++;
                            addLog(`✓ ${url}: ${response.status} ${response.statusText}`, 'success');
                        } else {
                            addLog(`✗ ${url}: ${response.status} ${response.statusText}`, 'warning');
                        }
                        
                        // 所有请求完成后显示摘要
                        if (completed === testUrls.length) {
                            addLog(`资源获取测试完成: ${successCount}/${testUrls.length} 成功`, 
                                  successCount === testUrls.length ? 'success' : 'warning');
                        }
                    })
                    .catch(err => {
                        completed++;
                        addLog(`✗ ${url}: 获取失败 - ${err.message}`, 'error');
                        
                        if (completed === testUrls.length) {
                            addLog(`资源获取测试完成: ${successCount}/${testUrls.length} 成功`, 'warning');
                        }
                    });
            });
        }
        
        // 处理Service Worker消息
        function handleServiceWorkerMessage(event) {
            addLog(`收到 Service Worker 消息: ${event.data.type || '未知类型'}`, 'info');
            
            switch (event.data.type) {
                case 'cache-status':
                    handleCacheStatus(event.data);
                    break;
                    
                case 'cache-config-response':
                    handleCacheConfig(event.data);
                    break;
                    
                case 'cache-config-updated':
                    addLog('缓存配置已更新', 'success');
                    // 更新配置显示
                    setTimeout(() => getCacheConfig(), 500);
                    break;
                    
                default:
                    addLog(`未处理的消息类型: ${event.data.type}`, 'warning');
            }
        }
        
        // 处理缓存状态
        function handleCacheStatus(data) {
            addLog('收到缓存状态数据', 'success');
            
            const status = data.status || data;
            const config = data.config || {};
            
            // 更新缓存状态显示
            if (status.error) {
                updateCacheStatus('error', `获取缓存状态失败: ${status.error}`);
            } else {
                updateCacheStatus('success', '缓存状态获取成功');
                
                // 更新统计数据卡片
                updateCacheStats(status.total);
                
                // 显示详细缓存信息
                let detailsText = `配置: MP3缓存=${config.enableMp3Cache ? '启用' : '禁用'}, 限制=${config.maxMp3CacheCount || 0}首\n\n`;
                
                if (status.details && Object.keys(status.details).length > 0) {
                    detailsText += '缓存详情:\n';
                    for (const [cacheName, cacheInfo] of Object.entries(status.details)) {
                        detailsText += `\n${cacheName}:\n`;
                        detailsText += `  文件数: ${cacheInfo.files}\n`;
                        detailsText += `  大小: ${cacheInfo.readableSize}\n`;
                        if (cacheInfo.mp3Files > 0) {
                            detailsText += `  MP3文件: ${cacheInfo.mp3Files} (${cacheInfo.mp3ReadableSize})\n`;
                        }
                    }
                } else {
                    detailsText += '\n无缓存详情数据';
                }
                
                cacheStatusContent.textContent = detailsText;
            }
        }
        
        // 处理缓存配置
        function handleCacheConfig(data) {
            addLog('收到缓存配置数据', 'success');
            
            const config = data.config || {};
            
            // 更新UI
            document.getElementById('enable-mp3-cache').checked = config.enableMp3Cache !== false;
            document.getElementById('mp3-cache-limit').value = config.maxMp3CacheCount || 30;
            document.getElementById('mp3-limit-value').textContent = config.maxMp3CacheCount || 30;
            
            // 显示配置
            let configText = `当前缓存配置:\n\n`;
            configText += `启用MP3缓存: ${config.enableMp3Cache !== false ? '是' : '否'}\n`;
            configText += `MP3缓存限制: ${config.maxMp3CacheCount || 30} 首\n`;
            configText += `其他缓存限制: ${config.maxOtherCacheCount || 50} 个文件\n`;
            
            cacheConfigContent.textContent = configText;
            updateCacheConfig('success', '配置获取成功');
        }
        
        // 更新缓存统计数据卡片
        function updateCacheStats(total) {
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total.files || 0}</div>
                    <div class="stat-label">总文件数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${total.readableSize || '0 B'}</div>
                    <div class="stat-label">总大小</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${total.mp3Files || 0}</div>
                    <div class="stat-label">MP3文件</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${total.mp3ReadableSize || '0 B'}</div>
                    <div class="stat-label">MP3大小</div>
                </div>
            `;
            
            cacheStats.innerHTML = statsHTML;
        }
        
        // 更新Service Worker状态显示
        function updateSwStatus(type, message) {
            // 移除所有状态类
            swStatus.classList.remove('success', 'error', 'warning');
            
            // 添加新状态类
            if (type === 'success') {
                swStatus.classList.add('success');
                swStatus.querySelector('.status-title i').className = 'fas fa-check-circle';
            } else if (type === 'error') {
                swStatus.classList.add('error');
                swStatus.querySelector('.status-title i').className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                swStatus.classList.add('warning');
                swStatus.querySelector('.status-title i').className = 'fas fa-exclamation-triangle';
            }
            
            swStatusContent.textContent = message;
        }
        
        // 更新缓存状态显示
        function updateCacheStatus(type, message) {
            // 移除所有状态类
            cacheStatus.classList.remove('success', 'error', 'warning');
            
            // 添加新状态类
            if (type === 'success') {
                cacheStatus.classList.add('success');
            } else if (type === 'error') {
                cacheStatus.classList.add('error');
            } else if (type === 'warning') {
                cacheStatus.classList.add('warning');
            }
            
            // 更新标题图标
            const title = cacheStatus.querySelector('.status-title');
            title.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i> ${message}`;
        }
        
        // 更新缓存配置显示
        function updateCacheConfig(type, message) {
            // 移除所有状态类
            cacheConfig.classList.remove('success', 'error', 'warning');
            
            // 添加新状态类
            if (type === 'success') {
                cacheConfig.classList.add('success');
            } else if (type === 'error') {
                cacheConfig.classList.add('error');
            } else if (type === 'warning') {
                cacheConfig.classList.add('warning');
            }
            
            // 更新标题图标
            const title = cacheConfig.querySelector('.status-title');
            title.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i> ${message}`;
        }
        
        // 添加日志
        function addLog(message, type = 'info') {
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let typeClass = 'log-info';
            if (type === 'error') typeClass = 'log-error';
            else if (type === 'success') typeClass = 'log-success';
            else if (type === 'warning') typeClass = 'log-warning';
            
            logEntry.innerHTML = `<span class="log-time">[${timeString}]</span> <span class="${typeClass}">${message}</span>`;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // 保存日志
            logs.push({ time: timeString, message, type });
            
            // 限制日志数量
            if (logs.length > 100) {
                logs.shift();
                const entries = logsContainer.querySelectorAll('.log-entry');
                if (entries.length > 0) {
                    logsContainer.removeChild(entries[0]);
                }
            }
        }
        
        // 清除日志
        function clearLogs() {
            if (!isAuthenticated) {
                addLog('请先验证密码才能操作', 'error');
                return;
            }
            
            logs = [];
            logsContainer.innerHTML = '<div class="log-entry"><span class="log-time">[系统]</span> <span class="log-info">日志已清除</span></div>';
        }
    </script>
</body>
</html>